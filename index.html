<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#064e3b">
	<link rel="apple-touch-startup-image" href="splash-screen.png">
	<link rel="icon" type="image/svg+xml" href="icons/wildly_icon.svg">

	<title>Wildly</title>
	<link rel="manifest" href="manifest.json">

	<!--Interaktivt kort-->
	<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
	<script src="lib/leaflet/leaflet.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --ios-bg: #fdfcfb; }
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: "Georgia", serif; 
            background-color: var(--ios-bg);
            color: #1c1c1e;
            user-select: none;
        }
        .sans { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .btn-active:active { transform: scale(0.97); opacity: 0.9; }
        .card { background: white; border-radius: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.06); }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .type-badge { font-family: sans-serif; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; padding: 4px 10px; border-radius: 12px; }
        .badge-svamp { background: #fef3c7; color: #92400e; }
        .badge-b√¶r { background: #fee2e2; color: #991b1b; }
        .badge-plante { background: #dcfce7; color: #166534; }
        .badge-n√∏d { background: #f3f4f6; color: #374151; }
        
        .id-label { font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; color: #064e3b; margin-bottom: 2px; font-family: sans-serif; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .season-trigger {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .season-select-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        /* Season Bar specific styles */
        .month-pill {
            flex: 1;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 900;
            font-family: sans-serif;
            text-transform: uppercase;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .month-active {
            background-color: #064e3b;
            color: white;
            box-shadow: 0 2px 4px rgba(6, 78, 59, 0.2);
        }
        .month-inactive {
            background-color: #f1f1f1;
            color: #626262;
        }

		/* Galleri */
	    /* Skjul scrollbar i galleriet */
	    .no-scrollbar::-webkit-scrollbar {
	        display: none;
	    }
	    .no-scrollbar {
	        -ms-overflow-style: none;
	        scrollbar-width: none;
	    }
	    
	    /* G√∏r swipe mere responsiv p√• iOS */
	    #swipe-gallery {
	        -webkit-overflow-scrolling: touch;
	    }

		.fab-container {
		    position: fixed;
		    bottom: 90px;
		    left: 0;
		    right: 0;
		    display: flex;
		    justify-content: center;
		    z-index: 100;
		    pointer-events: none; 
		}
		
		.floating-save-btn {
		    pointer-events: auto;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    gap: 8px;
		    padding: 12px 20px;
		    background-color: #064e3b;
		    color: white;
		    border-radius: 9999px;
		    border: 2px solid white;
		    font-weight: bold;
		    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
		    font-size: 14px;
		    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
		    
		    /* Animation n√•r knappen dukker op */
		    animation: fab-pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		    transition: transform 0.1s ease;
		}
				
		@keyframes pop-in {
		    0% { transform: scale(0) rotate(-45deg); opacity: 0; }
		    100% { transform: scale(1) rotate(0); opacity: 1; }
		}		
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-stone-100 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button id="back-btn" onclick="goBack()" class="hidden w-10 h-10 flex items-center justify-center bg-stone-100 rounded-full btn-active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg>
            </button>
			
            <h1 class="text-2xl font-black tracking-tighter uppercase italic sans">Wild<span class="text-green-800">ly</span></h1>																												 
        </div>
    </header>

    <main id="app-content" class="flex-1 p-6 max-w-lg mx-auto w-full pb-32"></main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-stone-100 safe-area-bottom z-50">
        <div class="grid grid-cols-5 h-16">
            <button onclick="navigate('start')" class="flex flex-col items-center justify-center gap-1 btn-active">
                <svg width="20" height="20" viewBox="0 0 1487.4724 1520.4724">
					<path d="m 1441.2362,30.23622 h 15 l 1,1 v 135 l -2,51 -3,42 -3,26 -3,41 -4,32 -3,25 -2,9 -2,25 -2,7 -2,16 -2,6 -3,25 -7,40 -6,31 -8,35 -10,40 -2,3 -5,21 -4,13 -7,24 -10,33 -13,35 -5,11 -5,14 -22,52 -8,16 -9,19 -12,22 -8,16 -15,26 -9,14 -4,7 -7,10 -11,18 -26,35.99998 -7,8 -7,11 -7,8 -9,11 -17,17 -4,6 -13,15 -5,6 -8,7 -10,10 -16,14 -5,5 -13,12 -8,7 -8,5 -9,9 -14,11 -8,6 -13,9 -19,13 -13,9 -10.99998,7 -17,10 -26,14 -15,8 -23,11 -25,10 -23,8 -33,11 -31,8 -42,8 -26,3 -43,2 h -13 l -45,-2 -27,-3 -41,-7 -28,-6 -36,-9 -51,-15 -33,-11 -16,-7 -17,-7 -8,-4 -10,-4 -6,-4 -8,-2 -11,-6 -1,-3 8,-16 11,-18 6,-9 6,-12 9,-16 24,-36 9,-14 6,-10 11,-16 13,-18 10,-12 4,-7 8,-11 10,-14 10,-11.99998 8,-11 8,-10 15,-20 9,-10 8,-10 11,-13 6,-8 9,-10 10,-11 7,-8 9,-10 8,-10 7,-7 7,-8 14,-15 3,-1 2,-4 6,-7 7,-6 7,-8 5,-6 5,-5 h 2 l 2,-4 4,-4 h 2 l 2,-4 16,-16 h 2 l 2,-4 15,-15 8,-7 13,-12 17,-17 8,-7 13,-12 9,-7 9,-9 10,-8 13,-12 22,-18 12,-9 7,-7 11,-9 13,-10 27,-21 17,-13 7,-5 -24,11 -16,8 -17,9 -23,13 -27,15 -16,10 -36,24 -14,9 -6,4 -5,4 -9,6 -11,9 -18,13 -12,9 -14,12 -12,10 -14,11 -20,18 -8,7 -10,9 -8,7 -17,16 -16,15 -11,12 -26,26 h -2 l -2,5 -10,10 -7,8 -9,10 -7,8 -12,13 -11,14 -10,12 -4,6 -7,7 -8,11 -12,13 -3,6 -7,9 -6,9 -5,5.99998 -7,9 -10,14 -6,8 -12,18 -10,14 -14,20 -9,14 -8,13 -11,17 -4,6 -3,4 h -2 l -2,7 -6,10 -4,6 -6,11 -8,14 -7,12 -7,11 -12,21 -4,6 -8,18 -12,22 -14,26 -8,16 -9,20 -6,13 -14,30 -4,9 -13,29 -11,29 -13,31 -3,9 -2,2 -9,-1 -19,-10 -16,-8 -15,-9 -9,-5 -2,-2 -7,-3 -19,-10 -6,-4 v -3 l 10,-19 14,-22 9,-16 11,-19 12,-19 4,-6 5,-6 3,-7 15,-25 10,-15 7,-11 8,-12 6,-8 11,-18 10,-15 21,-30 8,-12 10,-14 8,-11 9,-12 9,-10 1,-1 -1,-9 -6,-14 -6,-18 -4,-10 -3,-10 -11,-36 -6,-28 -8,-48.99998 -2,-11 -2,-28 -2,-6 -2,-40 v -30 l 1,-9 1,-27 3,-12 1,-19 9,-49 5,-23 10,-30 4,-11 10,-24 8,-17 7,-16 8,-16 9,-15 8,-13 6,-10 3,-3 6,-11 12,-17 11,-14 6,-8 9,-10 16,-20 6,-7 19,-19 6,-5 7,-8 15,-13 8,-7 6,-4 4,1 5,6 11,20 10,13 12,11 16,12 14,8 15,5 12,3 12,1 h 24 l 12,-2 24,-7 11,-6 11,-7 11,-9 6,-2 5,4 7,11 8,11 12,13 11,9 10,7 14,6 11,4 14,4 h 40 l 16,-5 16,-6 16,-10 11,-9 11,-13 9,-13 8,-16 5,-5 26,7 11,2 h 22 l 20,-4 18,-6 16,-10 20,-16 11,-14 8,-13 6,-13 5,-15 3,-8 1,-15 0.99998,-31 11,-5 11,-4 12,-8 14,-12 8,-7 10,-13 8,-16 7,-19 5,-17 v -31 l -9,-29 -10,-21 -3,-5 v -6 l 4,-4 15,-5 17,-5 26,-6 22,-3 5,-2 18,-2 5,-2 8,-2 5,-2 12,-1 8,-3 11,-2 5,-2 17,-4 17,-2 5,-2 34,-7 18,-3 33,-6 38,-6 6,-2 17,-1 6,-2 2,-1 15,-1 z m -524.99998,534 -1,2 4,-2 z" fill="#064D34"></path>
				</svg>
                <span data-i18n="menu_home" class="text-[9px] font-black uppercase sans text-stone-600">&nbsp;</span>
            </button>
            <button onclick="navigate('all')" class="flex flex-col items-center justify-center gap-1 btn-active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/></svg>
                <span data-i18n="menu_library" class="text-[9px] font-black uppercase sans text-stone-600">&nbsp;</span>
            </button>
            <button onclick="navigate('wizard', 'START')" class="flex flex-col items-center justify-center gap-1 btn-active text-green-800">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M12 13v8M5 13c0-3.87 3.13-7 7-7s7 3.13 7 7H5Z"></path>
				</svg>
				<span data-i18n="menu_mushroom_id" class="text-[9px] font-black uppercase sans">&nbsp;</span>
            </button>
            
            <div class="season-trigger btn-active">
                <div id="season-icon-container" class="flex flex-col items-center justify-center gap-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span data-i18n="all_year" id="season-label" class="text-[9px] font-black uppercase sans text-stone-600">&nbsp;</span>
                </div>
                <select id="season-picker" onchange="handleSeasonChange(this.value)" class="season-select-overlay">
                    <option data-i18n="all_year" value="all">Hele √Öret</option>
                    <option data-i18n="month_jan" value="jan">Jan</option>
                    <option data-i18n="month_feb" value="feb">Feb</option>
                    <option data-i18n="month_mar" value="mar">Mar</option>
                    <option data-i18n="month_apr" value="apr">Apr</option>
                    <option data-i18n="month_may" value="maj">Maj</option>
                    <option data-i18n="month_jun" value="jun">Jun</option>
                    <option data-i18n="month_jul" value="jul">Jul</option>
                    <option data-i18n="month_aug" value="aug">Aug</option>
                    <option data-i18n="month_sep" value="sep">Sep</option>
                    <option data-i18n="month_oct" value="okt">Okt</option>
                    <option data-i18n="month_nov" value="nov">Nov</option>
                    <option data-i18n="month_dec" value="dec">Dec</option>
                </select>
            </div>

			<button onclick="toggleMenu()" class="flex flex-col items-center justify-center gap-1 btn-active text-stone-600">
			    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
			        <line x1="3" y1="12" x2="21" y2="12"></line>
			        <line x1="3" y1="6" x2="21" y2="6"></line>
			        <line x1="3" y1="18" x2="21" y2="18"></line>
			    </svg>
			    <span data-i18n="menu_menu" class="text-[9px] font-black uppercase sans">&nbsp;</span>
			</button>
        </div>
    </nav>
	<div id="menu-overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/40 z-[3000] hidden backdrop-blur-sm transition-opacity"></div>
	
	<div id="side-menu" class="fixed top-0 left-0 h-full w-[80%] max-w-[320px] bg-[#fdfcfb] z-[3001] shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out p-6 flex flex-col">
		<div class="flex justify-between items-center mb-8">
			<h2 data-i18n="menu_menu" class="text-2xl font-black italic uppercase tracking-tighter">Menu</h2>
			<button onclick="toggleMenu()" class="text-2xl">‚úï</button>
		</div>
	
		<div class="space-y-6 flex-1 overflow-y-auto">
			<section class="bg-stone-100 rounded-2xl overflow-hidden divide-y divide-stone-200">
			    <div class="flex items-center px-4 py-2 justify-between">
			        <span data-i18n="menu_language" class="text-[10px] font-bold uppercase tracking-widest text-stone-500">Sprog</span>
			        <select id="lang-select" onchange="handleLangChange(this.value)" class="bg-transparent text-sm font-bold text-emerald-900 border-none focus:ring-0 py-1 text-right">
			        </select>
			    </div>
			
			    <div class="flex items-center px-4 py-2 justify-between">
			        <span data-i18n="menu_country" class="text-[10px] font-bold uppercase tracking-widest text-stone-500">Land</span>
			        <select id="country-select" onchange="handleCountryChange(this.value)" class="bg-transparent text-sm font-bold text-emerald-900 border-none focus:ring-0 py-1 text-right">
			        </select>
			    </div>
			
			    <div class="flex items-center px-4 py-2 justify-between">
			        <span data-i18n="menu_region" class="text-[10px] font-bold uppercase tracking-widest text-stone-500">Region</span>
			        <select id="region-select" onchange="handleRegionChange()" class="bg-transparent text-sm font-bold text-emerald-900 border-none focus:ring-0 py-1 text-right">
			        </select>
			    </div>
			</section>

			<nav class="space-y-1">
				<div id="user-section" class="bg-stone-100 rounded-3xl p-2 space-y-1">
    			</div>
				<button onclick="navigate('safety')" class="w-full text-left py-3 border-b border-stone-100 flex items-center gap-3">
					<span class="text-lg">‚ö†</span> <span data-i18n="menu_safety" class="font-bold text-sm">Sikkerhed</span>
				</button>
				<button onclick="reportBug()" class="w-full text-left py-3 border-b border-stone-100 flex items-center gap-3">
					<span class="text-lg">‚úâ</span> <span data-i18n="menu_feedback" class="font-bold text-sm">Giv tilbagemelding</span>
				</button>
			</nav>
		</div>
		
		<div class="mt-auto pt-6 text-[8px] text-stone-400 uppercase tracking-widest text-center">
			Wildy v2.0
		</div>
	</div>
	
    <script>
		//GLOBALS
		let ui = {}; // Vores eneste globale objekt til interface-tekster
		let map; // Global variabel til kortet
		let activeMarkers = {};
		let currentPageId = 'start';
		// Global variable to track where we are in the tree
		let currentWizardNode = {};
		let wizardMushroomData = {};
		let isLoggedIn = false;
		let userSettings = JSON.parse(localStorage.getItem('userSettings')) || {
		    lang: 'da',
		    country: 'DK',
		    region: 'Hele landet'
		};		
        let activeSeason = 'all';
		let appConfig = {};
		let geoData = {};
		let database = {};
		
		function toggleMenu() {
		    const menu = document.getElementById('side-menu');
		    const overlay = document.getElementById('menu-overlay');
		    const isOpen = !menu.classList.contains('-translate-x-full');
		
		    if (isOpen) {
		        menu.classList.add('-translate-x-full');
		        overlay.classList.add('hidden');
		        document.body.style.overflow = ''; // Tillad scroll igen
		    } else {
		        menu.classList.remove('-translate-x-full');
		        overlay.classList.remove('hidden');
		        document.body.style.overflow = 'hidden'; // L√•s scroll
		    }
		}

		function closeMenuIfOpen() {
		    const menu = document.getElementById('side-menu');
		    const overlay = document.getElementById('menu-overlay');
		    if (menu && !menu.classList.contains('-translate-x-full')) {
		        menu.classList.add('-translate-x-full');
		        overlay.classList.add('hidden');
		        document.body.style.overflow = '';
		    }
		}

		function renderLanguageOptions() {
		    const langSelect = document.getElementById('lang-select');
		    if (!langSelect || !appConfig.languages) return;
		
		    // Byg listen af sprog baseret p√• n√∏glerne i config.json (da, en, de osv.)
		    langSelect.innerHTML = Object.keys(appConfig.languages).map(langKey => {
		        const lang = appConfig.languages[langKey];
		        return `<option value="${langKey}" ${userSettings.lang === langKey ? 'selected' : ''}>
		            ${lang.label}
		        </option>`;
		    }).join('');
		}

		async function loadInterfaceTranslations(langCode) {
		    try {
				let response = await fetch('data/translations.json');
				const allTranslations = await response.json();
		        
		        // Vi gemmer KUN det sprog vi skal bruge i 'ui'
		        ui = allTranslations[langCode] || allTranslations['en'];
		        
		        // Opdater de statiske elementer i HTML'en med det samme
		        applyStaticTranslations(); 
		    } catch (err) {
		        console.error("Could not load translations:", err);
		    }
		}

		function applyStaticTranslations() {
		    document.querySelectorAll('[data-i18n]').forEach(el => {
		        const key = el.getAttribute('data-i18n');
		        if (ui[key]) {
		            // H√•ndter b√•de almindelig tekst og input-placeholders
		            if (el.tagName === 'INPUT') el.placeholder = ui[key];
		            else el.innerText = ui[key];
		        }
		    });
		}

		async function handleLangChange(langCode, shouldRender = true) {
		    userSettings.lang = langCode;
		    const langData = appConfig.languages[langCode];
			await loadInterfaceTranslations(langCode);
			
			// 1. Find ud af hvilket land vi skal bruge
		    let activeCountry = userSettings.country;
		
		    // Tjek om landet mangler ELLER om det nuv√¶rende land ikke findes i det nye sprogs liste
		    if (!activeCountry || !langData.countries[activeCountry]) {
		        activeCountry = langData.defaultCountry;
		    }
		
		    // Opdater userSettings med det valgte/validerede land
		    userSettings.country = activeCountry;
			
		    // Opdater lande-v√¶lgeren i menuen
		    const countrySelect = document.getElementById('country-select');
		    if (countrySelect) {
		        countrySelect.innerHTML = Object.keys(langData.countries).map(code => 
		            `<option value="${code}" ${activeCountry === code ? 'selected' : ''}>
		                ${langData.countries[code].label}
		            </option>`
		        ).join('');
		    }

			renderUserSection();			
		    await handleCountryChange(activeCountry, shouldRender);
		}	
		
		async function handleCountryChange(countryCode, shouldRender = true) {
		    // 1. Opdater indstillingerne for land
		    userSettings.country = countryCode;

		    // 2. Hent geografiske data for det valgte land fra geoData
		    const countryConfig = geoData[countryCode];
		    		
		    const regionIds = Object.keys(countryConfig.regions);
		    const currentRegion = userSettings.region;
		
		    // 3. Valider region: Behold nuv√¶rende hvis den findes i det nye land, 
		    // ellers v√¶lg den f√∏rste (typisk 'all')
		    if (!currentRegion || !countryConfig.regions[currentRegion]) {
		        userSettings.region = regionIds[0]; 
		    }
		
		    // 4. Opdater regions-dropdown i menuen
		    const regionSelect = document.getElementById('region-select');
		    if (regionSelect) {
		        regionSelect.innerHTML = Object.entries(countryConfig.regions).map(([id, data]) => {
		            // Vi henter label baseret p√• det aktive sprog, fallback til ID
		            const label = data.label[userSettings.lang] || data.label['da'] || id;
		            const isSelected = userSettings.region === id;
		            
		            return `<option value="${id}" ${isSelected ? 'selected' : ''}>${label}</option>`;
		        }).join('');
		    }
			
		    // 5. Gem de nye indstillinger
		    saveSettings(); 
		    		
		    // 6. K√∏r region-skiftet (som ofte h√•ndterer rendering)
		    await handleRegionChange(shouldRender);
		}
		
		async function handleRegionChange(shouldRender = true) {
			const response = await fetch(`data/regions/${userSettings.country}_wizardMushroomData.json`);
			const uiWizard = await response.json();

			// 1. Opdater indstillingerne
			const regionSelect = document.getElementById('region-select');
			userSettings.region = regionSelect.value;
		    
		    // 2. Find regionerne for det valgte land i det valgte sprog
			wizardMushroomData = uiWizard[userSettings.lang][userSettings.region];
			
		    // 4. Gem de nye indstillinger permanent
		    saveSettings();
		
		    // 5. Hent den nye lande-database (f.eks. data_dk.json)
		    await loadDatabase();
		
		    // 6. Hvis vi skal opdatere sk√¶rmen med det samme (f.eks. n√•r man skifter i menuen)
		    if (shouldRender) {
		        render(currentPageId);
		    }
		}

		// Hj√¶lpefunktion til at flette (merge) objekter dybt sammen
		function deepMerge(target, ...sources) {
		    if (!sources.length) return target;
		    const source = sources.shift();
		
		    if (target && typeof target === 'object' && !Array.isArray(target) && 
		        source && typeof source === 'object' && !Array.isArray(source)) {
		        for (const key in source) {
		            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
		                if (!target[key]) Object.assign(target, { [key]: {} });
		                deepMerge(target[key], source[key]);
		            } else {
		                Object.assign(target, { [key]: source[key] });
		            }
		        }
		    }
		    return deepMerge(target, ...sources);
		}
		
		async function loadDatabase() {
			const lang = userSettings.lang;
			const country = userSettings.country;
			const region = userSettings.region;

			try {
				// 1. Hent de tre n√∏dvendige filer parallelt
				const [uniRes, langRes, regRes] = await Promise.all([
					fetch('data/universal.json'),
					fetch(`data/lang/${lang}.json`),
					fetch(`data/regions/${country}.json`)
				]);
		
				const universal = await uniRes.json();
				const langData = await langRes.json();
				const regionData = await regRes.json();
		
				const flatDatabase = {};
		
				// 2. Loop KUN over de arter, der findes i det valgte land
				for (const id in regionData) {
					const regObj = regionData[id];
					const commonData = regObj.all || {};
					const specificRegionData = regObj[region];
		
					// SIKKERHEDS-TJEK: Vokser den overhovedet her?
					// Hvis der ikke er nogen 'common' data, og den heller ikke er n√¶vnt 
					// i den valgte region, s√• spring den over.
					if (Object.keys(commonData).length === 0 && !specificRegionData) {
						continue; 
					}
		
					let entry = { id: id };
		
					// A: Start med at hente de universelle grunddata (type, latin)
					if (universal[id]) {
						deepMerge(entry, universal[id]);
					}
		
					// B: L√¶g de globale sprog-tekster p√• (navn, traits, id_keys)
					if (langData[id]) {
						deepMerge(entry, langData[id]);
					}
		
					// C: P√•l√¶g Common Base Data for landet (habitats, months osv.)
					let commonBase = { ...commonData };
					delete commonBase.i18n; // Undg√• at overskrive med hele i18n objektet
					deepMerge(entry, commonBase);
		
					// D: P√•l√¶g Common Sprog Data for landet (f.eks. dansk extended_habitat)
					if (commonData.i18n && commonData.i18n[lang]) {
						deepMerge(entry, commonData.i18n[lang]);
					}
		
					// E: Hvis brugerens valgte region har unikke data, s√• overskriv med dem!
					if (specificRegionData) {
						let specificBase = { ...specificRegionData };
						delete specificBase.i18n;
						deepMerge(entry, specificBase); // Kan f.eks. √¶ndre 'months' for Nordjylland
		
						// F: Regionale sprog-variationer (f.eks. lokal forvekslingsfare)
						if (specificRegionData.i18n && specificRegionData.i18n[lang]) {
							deepMerge(entry, specificRegionData.i18n[lang]);
						}
					}
		
					// 3. Tilf√∏j det f√¶rdige, skr√¶ddersyede objekt til appens database
					flatDatabase[id] = entry;
				}

				database = flatDatabase;
		
			} catch (error) {
				console.error("Could not parse and build database:", error);
				return null;
			}
		}

		// Hj√¶lpefunktion til at gemme i localStorage
		function saveSettings() {
		    localStorage.setItem('userSettings', JSON.stringify(userSettings));
		}

		function renderUserSection() {
		    const container = document.getElementById('user-section');
		    if (!container) return;
		
		    const count = getSpotCount();
		    const countBadge = `<span class="ml-auto bg-emerald-100 text-emerald-700 text-[10px] font-black px-2 py-0.5 rounded-full">${count}</span>`;
		
		    if (!isLoggedIn) {
		        container.innerHTML = `
		            <button onclick="navigate('my-spots')" class="w-full text-left py-3 px-3 flex items-center gap-3">
		                <span class="text-lg">üìç</span> 
		                <div class="flex flex-col">
		                    <span class="font-bold text-sm">${ui.my_spots}</span>
		                </div>
		                ${countBadge}
		            </button>
		            <section class="bg-emerald-900 text-white p-4 rounded-2xl shadow-md mb-2">
		                <h3 class="font-black italic uppercase text-sm mb-1">${ui.save_in_cloud}</h3>
		                <p class="text-[10px] opacity-80 mb-3">${ui.save_in_cloud_expl}.</p>
		                <button onclick="handleLogin()" class="w-full bg-white text-emerald-900 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">
		                    ${ui.log_in_register}
		                </button>
		            </section>		            
		        `;
		    } else {
		        container.innerHTML = `
		            <button onclick="navigate('my-spots')" class="w-full text-left py-3 px-3 flex items-center gap-3 bg-white rounded-xl">
		                <span class="text-lg">üìç</span> 
		                <div class="flex flex-col text-emerald-900">
		                    <span class="font-bold text-sm">${ui.my_spots}</span>
		                </div>
		                ${countBadge}
		            </button>
		            <div class="flex items-center gap-3 p-3 bg-white rounded-2xl shadow-sm mb-1">
		                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-700 font-bold italic">
		                    ${userSettings.name ? userSettings.name[0] : 'U'}
		                </div>
		                <div class="flex flex-col">
		                    <span class="font-bold text-sm italic">Profilnavn</span>
		                </div>
		            </div>		
		        `;
		    }
		}

		function handleLogin() {
		    alert("Her √•bnes Stripe / Google Login vindue...");
		    // Her integreres senere Firebase Auth eller lignende.

			// Her ville din rigtige login-kode v√¶re
		    console.log("Logging in...");
		    
		    // For test: Lad os lade som om login lykkedes
		    isLoggedIn = true;
		    renderUserSection(); // Opdaterer menuen med det samme uden at genindl√¶se siden
		}
	
		function reportBug() {
		    closeMenuIfOpen();
		    
		    // Vi g√∏r emnet og teksten lidt mere generel
		    const subject = encodeURIComponent("${ui.feedback_subject}");
			const body = encodeURIComponent(`${ui.feedback_content} (${ui.menu_language}: ${userSettings.lang}, ${ui.menu_country}: ${userSettings.country})`);
		    
		    window.location.href = `mailto:support@wild.ly?subject=${subject}&body=${body}`;
		}
	
		function render(pageId, data) {
		    // Hvis pageId ikke er defineret (f.eks. ved reload), brug 'start'
		    const current = pageId || 'start';
			currentPageId = pageId;
			
		    // Styr tilbage-knappens synlighed
		    const backBtn = document.getElementById('back-btn');
		    if (current === 'start') {
		        backBtn.classList.add('hidden');
		    } else {
		        backBtn.classList.remove('hidden');
		    }
		
		    // Scroll til toppen ved skift
		    window.scrollTo(0,0);
		
		    // V√¶lg hvad der skal vises
		    if (current === 'start') {
		        renderStart();
		    } else if (current === 'my-spots') {
		        renderMySpots(); // Nu er kortet med i navigationen!
		    } else if (current === 'wizard') {
		        // Vi sender data (noden) med til renderWizard
		        renderWizard(data || 'START');
		    } else if (current === 'all') {
		        renderAll();
		    } else if (current === 'view_spot') {
			    renderSpot(data.spotId);
			} else if (current === 'safety') {
		        renderSafety();
		    } else if (current === 'view_forest_type') {
		        renderForestMenu();
		    } else if (typeof current === 'string' && current.startsWith('view_')) {
		        renderHabitat(current.replace('view_', ''));
		    } else if (database[current]) { // Tjekker om ID findes i databasen (res_...)
		        renderResult(current);
		    }
		}

        function handleSeasonChange(val) {
            activeSeason = val;
            const label = document.getElementById('season-label');
            const iconCont = document.getElementById('season-icon-container');
            
            if(val !== 'all') {
                label.innerText = val.toUpperCase();
                iconCont.classList.add('text-green-800');
                label.classList.remove('text-stone-600');
            } else {
                label.innerText = ui.all_year;
                iconCont.classList.remove('text-green-800');
                label.classList.add('text-stone-600');
            }

			const appContent = document.getElementById('app-content');
		    if (appContent.innerHTML.includes(ui.my_spots)) {
		        renderMySpots(); // Opdater listen med det samme
		    } else {
		        render(); // Ellers k√∏r din normale forside-render
		    }
        }
		
        function renderStart() {
			const activeHabitats = geoData[userSettings.country].regions[userSettings.region].activeHabitats;

			document.getElementById('app-content').innerHTML = `
				<div class="fade-in space-y-6">
                    <div class="p-10 card bg-green-900 text-white border-0 shadow-xl overflow-hidden relative">
                        <div class="relative z-10">
                            <h2 class="text-3xl font-black italic sans uppercase tracking-tighter leading-none">${ui.start_title}</h2>
                            <p class="text-green-200 text-[10px] font-bold uppercase tracking-[0.2em] mt-3 sans">${ui.start_guide} ${appConfig.languages[userSettings.lang].countries[userSettings.country].label}</p>
                        </div>
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
                    </div>
					<div class="grid grid-cols-2 gap-4">
						${activeHabitats.map(id => {
							const label = ui[`hab_${id}`] || id;
						    const isForest = (id === 'forest');
							
							return isForest ? `
								<button onclick="navigate('view_forest_type')" class="p-6 card flex flex-col items-center justify-center gap-2 btn-active">
									<span class="font-black text-stone-900 uppercase italic sans text-lg">${label}</span>
									<span class="text-[9px] font-bold text-green-700 uppercase sans font-black text-center">
										${ui.start_forest_type || 'V√¶lg skovtype'} ‚Üí
									</span>
								</button>
							` : `
								<button onclick="navigate('view_${id}')" class="p-6 card flex flex-col items-center justify-center gap-2 btn-active">
									<span class="font-black text-stone-900 uppercase italic sans text-lg">${label}</span>
									<span class="text-[9px] font-bold text-stone-600 uppercase sans">
										${ui.start_explore || 'Udforsk'}
									</span>
								</button>
							`;
		                }).join('')}
					</div>

                    <button onclick="navigate('all')" class="w-full p-6 card flex items-center justify-between btn-active">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-stone-100 rounded-2xl flex items-center justify-center font-bold text-green-800 italic sans text-xl">${ui.start_letter_range || 'A-√Ö'}</div>
                            <div class="text-left">
                                <div class="font-black text-stone-900 uppercase italic sans text-lg">${ui.start_library || 'Biblioteket'}</div>
                                <div class="text-[9px] font-bold text-stone-600 uppercase sans">${ui.start_library_all || 'Alle'} ${Object.keys(database).length} ${ui.start_library_species || 'arter'}</div>
                            </div>
                        </div>
                    </button>

					<button onclick="navigate('my-spots')" 
							class="w-full p-4 border-2 border-stone-200 text-stone-600 rounded-[24px] font-black text-[11px] uppercase tracking-widest text-center mt-4">
						${ui.start_my_spots || 'Mine hemmelige steder'} üìç
					</button>
                </div>
            `;
        }

		function renderForestMenu() {
			document.getElementById('app-content').innerHTML = `
				<div class="fade-in space-y-6">
					<div class="flex items-center gap-3">
						<h2 class="text-2xl font-black text-stone-900 italic uppercase tracking-tighter sans">${ui.start_forest_type}</h2>
					</div>

					<div class="grid grid-cols-1 gap-4">
						<button onclick="navigate('view_deciduous')" class="p-6 card flex items-center justify-between btn-active">
							<div class="text-left">
								<span class="block font-black text-stone-900 uppercase italic sans text-xl">${ui.hab_deciduous}</span>
								<span class="text-xs font-bold text-stone-600 uppercase">${ui.hab_deciduous_description}</span>
							</div>
						</button>

						<button onclick="navigate('view_coniferous')" class="p-6 card flex items-center justify-between btn-active">
							<div class="text-left">
								<span class="block font-black text-stone-900 uppercase italic sans text-xl">${ui.hab_coniferous}</span>
								<span class="text-xs font-bold text-stone-600 uppercase">${ui.hab_coniferous_description}</span>
							</div>
						</button>

						<button onclick="navigate('view_forest')" class="p-6 card flex items-center justify-between btn-active">
							<div class="text-left">
								<span class="block font-black text-stone-900 uppercase italic sans text-xl">${ui.hab_mixed}</span>
								<span class="text-xs font-bold text-stone-600 uppercase">${ui.hab_mixed_description}</span>
							</div>
						</button>
					</div>
				</div>
			`;
		}

        function renderAll() {
            const appContent = document.getElementById('app-content');
            let list = Object.entries(database).sort((a, b) => a[1].name.localeCompare(b[1].name));

            const renderList = (filterText = "") => {
                const filtered = list.filter(([id, data]) => {
                    const matchesSearch = data.name.toLowerCase().includes(filterText.toLowerCase()) || 
                                        data.type.toLowerCase().includes(filterText.toLowerCase());
                    const matchesSeason = activeSeason === 'all' || (data.months && data.months.includes(activeSeason));
                    return matchesSearch && matchesSeason;
                });

                const listHtml = filtered.map(([id, data]) => `
                    <button onclick="navigate('${id}')" class="w-full card p-5 flex flex-col btn-active text-left mb-3">
                        <div class="flex items-center justify-between w-full mb-2">
                            <div>
                                <div class="font-black text-stone-900 text-lg sans uppercase italic tracking-tighter leading-none">${data.name}</div>
                                <div class="text-[10px] font-bold text-stone-600 uppercase sans mt-1">${data.type} ‚Ä¢ ${data.habitats.map(h => ui[`hab_${h}`] || h).join('/')}</div>
                            </div>
                            <span class="type-badge badge-${data.type}">${data.type[0]}</span>
                        </div>
                        <div class="text-xs font-medium text-stone-600 italic line-clamp-1">${data.traits}</div>
                    </button>
                `).join('');

                document.getElementById('search-results').innerHTML = listHtml || '<p class="text-center py-10 text-stone-600 italic sans">${ui.no_search_results}</p>';
            };

            appContent.innerHTML = `
                <div class="fade-in space-y-4">
                    <h2 class="text-3xl font-black text-stone-900 italic uppercase tracking-tighter sans mb-4">${ui.menu_library}</h2>
                    <div class="relative mb-6">
                        <input type="text" id="search-input" placeholder="${ui.search_placeholder}" 
                            class="w-full p-4 pl-12 rounded-2xl border-none bg-stone-100 sans font-bold text-stone-900 focus:ring-2 focus:ring-green-800 outline-none transition-all">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-stone-600">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </div>
                    </div>
                    <div id="search-results"></div>
                </div>
            `;

            const searchInput = document.getElementById('search-input');
            if(searchInput) searchInput.addEventListener('input', (e) => renderList(e.target.value));
            renderList();
        }

        function renderHabitat(habitatId) {
			const title = ui[`hab_${habitatId}`] || habitatId;
			const list = Object.entries(database)
				.filter(([id, data]) => {
		            const plantHabitats = data.habitats || [];
		
		            // Speciel logik for blandingsskov (viser b√•de l√∏v og n√•l)
		            if (habitatId === 'forest') {
		                return plantHabitats.includes('deciduous') || plantHabitats.includes('coniferous') || plantHabitats.includes('forest');
		            }
		
		            // Standard tjek
		            return plantHabitats.includes(habitatId);
		        })
		        .filter(d => activeSeason === 'all' || (d[1].months && d[1].months.includes(activeSeason)))
		        .sort((a, b) => a[1].name.localeCompare(b[1].name));				

            document.getElementById('app-content').innerHTML = `
                <div class="fade-in space-y-4">
                    <h2 class="text-3xl font-black text-stone-900 italic uppercase tracking-tighter sans mb-6">${title}</h2>
                    <div class="space-y-4">
		                ${list.length > 0 ? list.map(([id, data]) => renderCard(id, data)).join('') : renderEmptyState()}
		            </div>
                </div>
            `;
        }

		function renderCard(id, data) {
		    return `
		    <button onclick="navigate('${id}')" class="w-full card p-6 flex flex-col btn-active text-left">
		        <div class="flex items-center justify-between mb-2">
		            <div class="font-black text-stone-900 text-xl uppercase italic tracking-tighter sans leading-none">
		                ${data.name}
		            </div>
		            <span class="type-badge badge-${data.type}">${data.type}</span>
		        </div>
		        <div class="text-sm font-medium text-stone-600 italic">
		            ${data.traits}
		        </div>
		    </button>`;
		}

		function renderEmptyState() {
		    return `<p class="text-center py-10 text-stone-600 italic sans">${ui.no_species_in_season}</p>`;
		}
		
		function showForestSubtypes() {
			const options = document.getElementById('forest-options');
			// Toggle visning af underkategorier
			options.classList.toggle('hidden');
			
			// Valgfrit: Scroll ned til mulighederne s√• brugeren ser dem
			if (!options.classList.contains('hidden')) {
				options.scrollIntoView({ behavior: 'smooth' });
			}
		}

        function getSeasonalityHtml(plantMonths) {
            return `
                <div class="flex gap-1 w-full mt-2">
                    ${ui.monthOrder.map(m => {
                        const isActive = plantMonths.includes(m);
                        return `<div class="month-pill ${isActive ? 'month-active' : 'month-inactive'}">${m[0]}</div>`;
                    }).join('')}
                </div>
            `;
        }

		function getDistance(lat1, lon1, lat2, lon2) {
		    const R = 6371; // Jordens radius i km
		    const dLat = (lat2 - lat1) * Math.PI / 180;
		    const dLon = (lon2 - lon1) * Math.PI / 180;
		    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
		              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
		    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		    const d = R * c;
		    return d; // Returnerer afstand i km
		}

		function getSpotCount() {
		    try {
		        const savedSpots = localStorage.getItem('mySpots'); // Antager dine fund hedder 'mySpots'
		        if (!savedSpots) return 0;
		        const spots = JSON.parse(savedSpots);
		        return Array.isArray(spots) ? spots.length : 0;
		    } catch (e) {
		        return 0;
		    }
		}

	function initOverviewMap(spots) {
		    setTimeout(() => {
				const container = document.getElementById('overview-map');
		        if (!container) return;
		
		        // 1. Tjek om vi er offline
		        if (!navigator.onLine) {
		            container.innerHTML = `
		                <div class="h-full w-full flex flex-col items-center justify-center bg-stone-100 text-stone-500 p-8 text-center border-2 border-dashed border-stone-200 rounded-2xl">
		                    <div class="text-4xl mb-3 opacity-50">üì°</div>
		                    <h3 class="font-bold text-lg mb-1">${ui.offline_map_title}</h3>
		                    <p class="text-xs font-sans leading-relaxed">
		                        ${ui.offline_map_msg}
		                    </p>
		                    <button onclick="render('start')" class="mt-4 text-xs font-bold uppercase tracking-widest text-emerald-700 border-b border-emerald-700 pb-1">
		                        ${ui.offline_map_button}
		                    </button>
		                </div>`;
		            return;
		        }

				const mapContainer = L.DomUtil.get('overview-map');
		        if (mapContainer != null) mapContainer._leaflet_id = null;
		
		        const overviewMap = L.map('overview-map', { zoomControl: false, attributionControl: false });
		        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(overviewMap);
		
		        activeMarkers = {}; 
		        const markerArray = [];
		
		        spots.forEach(spot => {
		            // RETTELSE 1: H√•ndter b√•de nye (flade) og gamle (nested) koordinater
		            const lat = spot.lat || (spot.location ? spot.location.lat : null);
		            const lng = spot.lng || (spot.location ? spot.location.lng : null);
		
		            if (!lat || !lng) return; // Spring over hvis ingen data
		
		            const marker = L.marker([lat, lng]).addTo(overviewMap);
		            
		            // RETTELSE 2: Definer 'plant' s√• popup'en virker
		            const plant = spot.info; 
		
		            const monthsHtml = spot.info.months.map(m => `
		                <span style="display:inline-block; font-size:7px; font-weight:800; padding:1px 4px; border-radius:3px; margin:0 1px; ${m === activeSeason ? 'background-color:#064e3b;color:white;' : 'background-color:#f5f5f4;color:#a8a29e;'}">${m}</span>
		            `).join('');
		
		            marker.bindPopup(`
		                <div class="p-2">
		                    <h3 class="font-bold">${plant.name}</h3>
							<div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 2px; margin-bottom: 10px;">
								${monthsHtml}
							</div>							
		                    <p class="text-xs text-gray-500 mb-2 font-sans">${new Date(spot.timestamp).toLocaleDateString()}</p>
		                    <div class="flex flex-col gap-2">
		                        <button onclick="navigate('view_spot', { spotId: '${spot.uid}' })" class="bg-emerald-600 text-white px-3 py-2 rounded text-xs font-bold">
									${ui.map_show_spot}
								</button>
								<button onclick="navigate('${spot.resId}')" class="border border-stone-300 bg-stone-50 text-stone-600 px-2 py-2 rounded text-[10px] font-bold uppercase tracking-wide flex items-center justify-center gap-1">
									${ui.map_plant_info}
								</button>
								<button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')" class="border border-blue-200 bg-blue-50 text-blue-700 px-2 py-2 rounded text-[10px] font-bold uppercase tracking-wide flex items-center justify-center gap-1">
									${ui.spot_get_directions}
								</button>
		                    </div>
		                </div>
		            `);
		            
		            activeMarkers[spot.originalIndex] = marker;
		            markerArray.push(marker);
		        });
		
		        if (markerArray.length > 0) {
		            const group = new L.featureGroup(markerArray);
		            overviewMap.fitBounds(group.getBounds().pad(0.3));
		        }
		        
		        window.currentMap = overviewMap;
		    }, 100);
		}

		// Funktionen der k√∏rer n√•r du trykker p√• et punkt i listen
		function focusSpotOnMap(originalIndex) {
		    const marker = activeMarkers[originalIndex];
		    if (marker && window.currentMap) {
		        window.currentMap.setView(marker.getLatLng(), 15, { animate: true });
		        marker.openPopup();
		        
		        const mapEl = document.getElementById('overview-map');
		        if(mapEl) mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
		    }
		}
		
		function showLocationEditor(id, loc) {
		    const modalHtml = `
		        <div id="location-editor" class="fixed inset-0 z-[110] flex flex-col bg-white">
		            <div class="p-6 flex justify-between items-center border-b">
		                <div>
		                    <h3 class="font-black uppercase italic tracking-tighter leading-none">${ui.spot_editor_set_location}</h3>
		                    <p class="text-[10px] text-stone-400 font-bold uppercase mt-1">${database[id].name}</p>
		                </div>
		                <button onclick="closeLocationEditor()" class="text-stone-400 font-bold text-sm">${ui.cancel}</button>
		            </div>
		            
		            <div class="relative flex-1 bg-stone-100">
		                <div id="map-container" class="w-full h-full"></div>
		                
		                <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-[1000]">
		                    <div class="flex flex-col items-center translate-y-[-20px]">
		                        <div class="bg-stone-900 text-white text-[8px] font-bold px-2 py-1 rounded mb-1 uppercase tracking-widest">${ui.spot_location}</div>
		                        <span class="text-4xl drop-shadow-2xl">üìç</span>
		                    </div>
		                </div>
		
		                <div class="absolute top-4 left-4 z-[1000] bg-white/90 backdrop-blur px-3 py-2 rounded-full shadow-sm border border-stone-200">
		                    <p class="text-[9px] font-black text-green-800 uppercase tracking-tighter leading-none">GPS: +/- ${loc.acc}m</p>
		                </div>
		            </div>
		
		            <div class="p-8 bg-white shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
		                <button onclick="saveFinalLocation('${id}', ${loc.acc})" 
		                        class="w-full p-6 bg-green-800 text-white rounded-[24px] font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
		                    ${ui.spot_confirm}
		                </button>
		            </div>
		        </div>
		    `;
		    document.body.insertAdjacentHTML('beforeend', modalHtml);
		
		    // Initialiser kortet efter HTML er indsat
		    setTimeout(() => {
		        map = L.map('map-container', {
		            zoomControl: false, // Vi gemmer knapperne for et rent look
		            attributionControl: false
		        }).setView([loc.lat, loc.lng], 18); // Zoom niveau 18 er godt til skov
		
		        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
		    }, 100);
		}
		
		function saveFinalLocation(resId, accuracy) {
			const center = map.getCenter();
		    
		    // 1. Skab et unikt ID for dette specifikke fund
		    const spotUid = 'spot_' + Date.now();
		    
		    const newDiscovery = { 
		        uid: spotUid,           // Unikt ID for fundet
		        resId: resId,           // ID p√• planten (f.eks. res_tragt)
		        lat: center.lat, 
		        lng: center.lng, 
		        acc: accuracy, 
		        timestamp: new Date().toISOString(),
		        photos: []              // G√∏r plads til billeder
		    };
		    
		    // 2. Hent eksisterende fund og tilf√∏j det nye
		    const existing = JSON.parse(localStorage.getItem('mySpots')) || [];
		    existing.push(newDiscovery);
		    localStorage.setItem('mySpots', JSON.stringify(existing));
		    
		    // 3. Opdater den globale variabel (hvis du bruger en)
		    if (typeof mySpots !== 'undefined') {
		        mySpots = existing;
		    }
		    
		    // 4. Luk editoren og naviger direkte til den nye fund-side
		    closeLocationEditor();

		    // Vi bruger 'view_spot' og sender vores nye unikke spotUid med
		    navigate('view_spot', { spotId: spotUid });
		}
		
		function closeLocationEditor() {
		    if(map) map.remove(); // Ryd op i hukommelsen
		    const editor = document.getElementById('location-editor');
		    if(editor) editor.remove();
		}
		
		// Henter GPS-koordinater med h√∏j pr√¶cision
		const getPreciseLocation = () => {
			return new Promise((resolve, reject) => {
				if (!navigator.geolocation) {
					reject(new Error(ui.map_no_gps));
				}
				navigator.geolocation.getCurrentPosition(
					(pos) => resolve({
						lat: pos.coords.latitude,
						lng: pos.coords.longitude,
						acc: Math.round(pos.coords.accuracy),
						timestamp: new Date().toISOString()
					}),
					(err) => reject(err),
					{ enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
				);
			});
		};

		// H√•ndterer "Gem"-knappen
		async function handleSaveLocation(id, btn) {
			if (btn.disabled) return;
			const originalContent = btn.innerHTML;
    		const originalWidth = btn.offsetWidth;
			const spinnerSvg = `
				<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
					<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
				</svg>`;
			
			btn.style.width = originalWidth + 'px';
    		btn.disabled = true;
		
			try {		
				btn.innerHTML = spinnerSvg;
				
				const location = await getPreciseLocation();
		        
		        // √Öbner editoren og sender ID med
		        showLocationEditor(id, location);
			} catch (error) {
		        console.error(error);
		        alert((ui.spot_gps_error) + " " + error.message);
		    } finally {
		        btn.innerHTML = originalContent;
		        btn.style.width = '';
		        btn.disabled = false;
		    }
		}

		async function renderMySpots(filterId = null) {
		    const container = document.getElementById('app-content');
		    container.innerHTML = `<div class="p-20 text-center animate-pulse text-stone-400">${ui.spot_calculating_distances}</div>`;

		    let userPos = null;
		    try {
		        userPos = await getPreciseLocation();
		    } catch (e) {
		        console.log(ui.spot_gps_not_available);
		    }
		
		    const spots = JSON.parse(localStorage.getItem('mySpots')) || [];
		    
		    // 1. Filtrer og beregn afstande
		    let processedSpots = spots.map((spot, index) => {
		        const info = database[spot.resId]; 
		        
		        const lat = spot.lat || (spot.location ? spot.location.lat : null);
		        const lng = spot.lng || (spot.location ? spot.location.lng : null);
		
		        let dist = null;
		        if (userPos && lat && lng) {
		            dist = getDistance(userPos.lat, userPos.lng, lat, lng);
		        }
		        return { ...spot, info, dist, originalIndex: index, lat, lng };
		    }).filter(s => {
		        const matchesSeason = (activeSeason === 'all' || s.info.months.includes(activeSeason));
		        // Hvis der er et filterId, skal resId matche. Ellers bare s√¶son-tjek.
		        return s.info && matchesSeason && (!filterId || s.resId === filterId);
		    });
		
		    // 2. Sorter efter afstand
		    if (userPos) {
		        processedSpots.sort((a, b) => a.dist - b.dist);
		    }

		    if (processedSpots.length === 0) {
		        const hasAnySpots = (JSON.parse(localStorage.getItem('mySpots')) || []).length > 0;
		        container.innerHTML = `
		            <div class="flex flex-col items-center justify-center min-h-[60vh] px-8 text-center fade-in">
		                <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center text-3xl mb-6">üìç</div>
		                <h3 class="text-xl font-black uppercase italic tracking-tighter text-stone-900 mb-2">
		                    ${hasAnySpots ? `${ui.no_species_in_season}` : `${ui.spot_no_saved}`}
		                </h3>
		                <p class="text-stone-500 text-sm italic leading-relaxed mb-8">
		                    ${hasAnySpots 
		                        ? `${ui.spot_change_month}` 
		                        : `${ui.spot_map_empty}`}
		                </p>
		                <button onclick="navigate('start')" class="px-8 py-4 bg-green-800 text-white rounded-full font-black text-[10px] uppercase tracking-widest shadow-lg">
		                    ${ui.go_to_home}
		                </button>
		            </div>
		        `;
		        return; 
		    }

			const title = filterId && processedSpots.length > 0 
			        ? `${ui.spot_finds_of} ${processedSpots[0].info.name} üìç` 
			        : `${ui.my_spots} üìç`;
			
			container.innerHTML = `
		        <div class="fade-in space-y-6 pb-20">
		            <div class="text-center px-4">
		                <h2 class="text-3xl font-black text-stone-900 uppercase italic tracking-tighter">${title}</h2>
						${filterId ? `<button onclick="renderMySpots()" class="text-[9px] font-bold text-emerald-600 uppercase">‚Üê ${ui.spot_all_species}</button>` : ''}
		            </div>
		
		            <div class="card overflow-hidden shadow-xl border-stone-100 mx-4">
		                <div id="overview-map" style="width: 100%; height: 350px;"></div>
		            </div>
		
		            <div class="space-y-3 px-4">
		                ${processedSpots.map((spot) => `
		                    <div class="card p-5 border-stone-100 flex justify-between items-center active:scale-[0.98] transition-all" 
		                         onclick="focusSpotOnMap('${spot.originalIndex}')">
		                        <div class="flex-1">
		                            <div class="flex items-center gap-2 mb-1">
		                                <span class="id-label !mb-0 text-[8px] opacity-40">
		                                    ${new Date(spot.timestamp).toLocaleDateString('da-DK')}
		                                </span>
		                                ${spot.dist !== null ? `
		                                    <span class="bg-amber-100 text-amber-800 text-[8px] font-black px-2 py-0.5 rounded-full uppercase">
		                                        ${spot.dist < 1 ? Math.round(spot.dist * 1000) + ' m' : spot.dist.toFixed(1) + ' km'}
		                                    </span>
		                                ` : ''}
		                            </div>
		                            <h4 class="text-xl font-black uppercase italic tracking-tighter text-stone-900">${spot.info.name}</h4>
		                            <div class="flex gap-1 mt-1">
		                                ${spot.info.months.map(m => `
		                                    <span class="text-[7px] font-bold uppercase px-1 rounded ${m === activeSeason ? 'bg-green-800 text-white' : 'bg-stone-100 text-stone-400'}">${m}</span>
		                                `).join('')}
		                            </div>
		                        </div>
		                        <button onclick="event.stopPropagation(); deleteFullSpot('${spot.uid}')" 
		                                class="ml-4 w-8 h-8 rounded-full bg-red-50 text-red-300 flex items-center justify-center text-xs">‚úï</button>
		                    </div>
		                `).join('')}
		            </div>
					</div> <div class="px-4 pt-8 pb-12 text-center">
			            <button onclick="clearAllSpots()" class="text-[10px] font-bold text-stone-400 uppercase tracking-widest border border-stone-200 px-6 py-3 rounded-full hover:bg-red-50 hover:text-red-500 hover:border-red-100 transition-all">
			                ${ui.spot_delete_all}
			            </button>
			        </div>
				</div>
		    `;
		
		    initOverviewMap(processedSpots);
		}
		
		async function clearAllSpots() {
		    if (confirm(ui.spot_delete_all_confirm)) {
		        
		        // 1. Ryd localStorage (kort-mark√∏rer og metadata)
		        localStorage.removeItem('mySpots');
		        
		        // 2. Ryd IndexedDB (alle billedfiler)
		        try {
		            const db = await photoStorage.init();
		            const tx = db.transaction("photos", "readwrite");
		            const store = tx.objectStore("photos");
		            
		            const request = store.clear();
		            
		            request.onsuccess = () => {
		                // 3. Opdater UI
		                if (typeof mySpots !== 'undefined') mySpots = [];
		                alert(ui.spot_deleted_all);
		                navigate('start');
		            };
		        } catch (err) {
		            console.error("Error with erasing images:", err);
		            navigate('start');
		        }
		    }
		}

		async function renderSpot(spotUid) {
		    const allSpots = JSON.parse(localStorage.getItem('mySpots')) || [];
		    const spot = allSpots.find(s => s.uid === spotUid);
		    if (!spot) return navigate('start');
		
		    const plantInfo = database[spot.resId];
		    
		    const app = document.getElementById('app-content');
		    const lat = spot.lat || (spot.location ? spot.location.lat : null);
			const lng = spot.lng || (spot.location ? spot.location.lng : null);
			const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
			
		    app.innerHTML = `
		        <div class="p-4 space-y-6 pb-20 fade-in">
		            <p class="text-[10px] text-emerald-800 font-bold uppercase tracking-widest mb-1">
					    ${new Date(spot.timestamp).toLocaleDateString()}
					</p>
					<h1 class="text-3xl font-black text-stone-900 uppercase italic tracking-tighter">${plantInfo.name}</h1>
		            
		            <div id="spot-map" class="w-full h-48 rounded-2xl border border-stone-200 shadow-inner mb-3"></div>
					${(lat && lng) ? `
					<button onclick="window.open('${mapsUrl}', '_blank')" 
					        class="w-full bg-stone-100 text-emerald-800 border-2 border-emerald-800/10 py-3 rounded-xl font-bold text-sm shadow-sm active:scale-[0.98] transition-transform flex items-center justify-center gap-2 mb-6">
					    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
					        <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
					    </svg>
					    ${ui.spot_get_directions}
					</button>
					` : ''}

		            <div>
		                <div class="flex justify-between items-end mb-3">
		                    <h2 class="text-sm font-bold text-stone-500 uppercase tracking-wider">${ui.spot_images}</h2>
		                    
		                    <div class="flex gap-3">
		                        <label class="flex items-center justify-center w-10 h-10 bg-emerald-100 text-emerald-700 rounded-full cursor-pointer active:scale-90 transition-transform shadow-sm">
		                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
		                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="addPhotoToSpot('${spotUid}', this)">
		                        </label>
		                        
		                        <label class="flex items-center justify-center w-10 h-10 bg-stone-100 text-stone-600 rounded-full cursor-pointer active:scale-90 transition-transform shadow-sm">
		                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
		                            <input type="file" accept="image/*" class="hidden" onchange="addPhotoToSpot('${spotUid}', this)">
		                        </label>
		                    </div>
		                </div>
		
		                <div class="grid grid-cols-3 gap-2" id="photo-grid">
		                    <div class="col-span-3 text-center py-8 text-stone-300 animate-pulse">${ui.spot_fetching_images}</div>
		                </div>
		            </div>
		
		            <div class="pt-6 space-y-3">
		                <button onclick="navigate('${spot.resId}')" class="w-full bg-emerald-800 text-white py-4 rounded-xl font-bold shadow-lg active:scale-[0.98] transition-transform">
		                    ${ui.spot_species_details} ${plantInfo.name}
		                </button>
		                <button onclick="deleteFullSpot('${spotUid}')" class="w-full text-red-400 py-3 text-xs font-bold uppercase tracking-widest hover:text-red-600">
		                    ${ui.spot_delete}
		                </button>
		            </div>
		        </div>
		    `;
		
		    // Initialis√©r kort (h√•ndterer b√•de nye flade coords og gamle nested coords)
		    setTimeout(() => {
		        const lat = spot.lat || (spot.location ? spot.location.lat : 0);
		        const lng = spot.lng || (spot.location ? spot.location.lng : 0);
		        
		        if (lat && lng) {
		            const smap = L.map('spot-map', { zoomControl: false, attributionControl: false }).setView([lat, lng], 15);
		            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(smap);
		            const m = L.marker([lat, lng]).addTo(smap);
		            // Deaktiver interaktion s√• det bare er et "billede"
		            smap.dragging.disable();
		            smap.touchZoom.disable();
		            smap.doubleClickZoom.disable();
		            smap.scrollWheelZoom.disable();
		        }
		    }, 100);
		
		    // Hent billeder
			try {
		        const photos = await photoStorage.getAll(spotUid);
		        const grid = document.getElementById('photo-grid');
		        
		        if (photos.length === 0) {
			        grid.innerHTML = `
			            <div class="col-span-3 bg-stone-50 rounded-xl border border-dashed border-stone-300 p-8 flex flex-col items-center justify-center text-stone-400 gap-2">
			                <svg class="w-8 h-8 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg>
			                <span class="text-xs font-medium">${ui.spot_no_images}</span>
			            </div>`;
		        } else {
					// Vi gemmer billederne i en global variabel eller p√• window-objektet 
			        // for at undg√• at sende gigantiske strenge direkte i HTML-attributten
			        window.currentSpotPhotos = photos.map(p => p.data);
					
			        grid.innerHTML = photos.map((photo, index) => `
			            <div class="relative aspect-square group">
			                <img src="${photo.data}" 
					             onclick='openFullImage(window.currentSpotPhotos, ${index})'
			                     class="w-full h-full object-cover rounded-xl shadow-sm border border-stone-100 cursor-zoom-in active:opacity-80 transition-opacity">
			                
			                <button onclick="event.stopPropagation(); deleteSinglePhoto('${spotUid}', ${photo.id})" 
			                        class="absolute -top-2 -right-2 bg-white text-red-500 rounded-full w-6 h-6 shadow-md flex items-center justify-center font-bold z-10 border border-stone-100">
			                        √ó
			                </button>
			            </div>
			        `).join('');
		        }
		    } catch (err) {
		        console.error("Error fetching photos:", err);
		        document.getElementById('photo-grid').innerHTML = `<p class="col-span-3 text-red-500 text-xs italic">${ui.spot_error_fetching_images}</p>`;
		    }
		}

		async function addPhotoToSpot(spotUid, input) {
		    if (input.files && input.files[0]) {
		        const reader = new FileReader();
		        reader.onload = async function(e) {
		            // Gem billedet i IndexedDB
		            await photoStorage.add(spotUid, e.target.result);
		            renderSpot(spotUid);
		        };
		        reader.readAsDataURL(input.files[0]);
				input.value = "";
		    }
		}
		
		function openFullImage(photoArray, startIndex) {
		    const overlay = document.createElement('div');
		    overlay.className = 'fixed inset-0 bg-black z-[2000] animate-in fade-in duration-200 overflow-hidden cursor-zoom-out';
		    
		    // Luk n√•r man klikker p√• selve overlay-baggrunden
		    overlay.onclick = (e) => {
		        document.body.removeChild(overlay);
		    };
			
		    overlay.innerHTML = `
		        <div class="flex h-full w-full overflow-x-auto snap-x snap-mandatory no-scrollbar" id="swipe-gallery">
		            ${photoArray.map((src, i) => `
		                <div class="min-w-full h-full snap-center flex items-center justify-center p-4">
		                    <img src="${src}" class="max-w-full max-h-full object-contain shadow-2xl">
		                </div>
		            `).join('')}
		        </div>
		        
		        <button class="absolute top-10 right-6 text-white bg-black/40 backdrop-blur-md w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold z-[2001]">‚úï</button>
		        
		        <div class="absolute bottom-10 left-0 right-0 text-center text-white/50 text-[10px] font-black uppercase tracking-widest z-[2001] pointer-events-none">
		            ${ui.gallery_swipe_or_click_to_close}
		        </div>
		    `;
		
		    document.body.appendChild(overlay);
		
		    // Scroll til det rigtige billede
		    const gallery = document.getElementById('swipe-gallery');
		    gallery.scrollLeft = startIndex * window.innerWidth;
		}

		async function deleteFullSpot(spotUid) {
		    if (confirm(ui.spot_delete_confirm)) {
		        // 1. Slet fra localStorage (mark√∏ren og data)
		        let existing = JSON.parse(localStorage.getItem('mySpots')) || [];
		        existing = existing.filter(s => s.uid !== spotUid);
		        localStorage.setItem('mySpots', JSON.stringify(existing));
		
		        // 2. Slet alle billeder i IndexedDB til dette spot
		        const photos = await photoStorage.getAll(spotUid);
		        for (let p of photos) {
		            await photoStorage.delete(p.id);
		        }
		
		        navigate('start');
		    }
		}
		
		async function deleteSinglePhoto(spotUid, photoId) {
		    if (confirm(ui.gallery_delete_image)) {
		        await photoStorage.delete(photoId);
		        renderSpot(spotUid); // Opdater visningen
		    }
		}
		
		const photoStorage = {
		    dbName: "WildlyDB",
		    storeName: "photos",
		
		    // √Öbner databasen
		    init() {
		        return new Promise((resolve, reject) => {
		            const request = indexedDB.open(this.dbName, 1);
		            request.onupgradeneeded = (e) => {
		                const db = e.target.result;
		                if (!db.objectStoreNames.contains(this.storeName)) {
		                    // Vi opretter et lager hvor hvert billede har et unikt ID
		                    // og et index s√• vi hurtigt kan finde alle billeder til √©t fund (spotUid)
		                    const store = db.createObjectStore(this.storeName, { keyPath: "id", autoIncrement: true });
		                    store.createIndex("spotUid", "spotUid", { unique: false });
		                }
		            };
		            request.onsuccess = () => resolve(request.result);
		            request.onerror = () => reject("Could not open IndexedDB");
		        });
		    },
		
		    // Gem et billede til et specifikt fund
		    async add(spotUid, base64Data) {
		        const db = await this.init();
		        return new Promise((resolve, reject) => {
		            const tx = db.transaction(this.storeName, "readwrite");
		            const store = tx.objectStore(this.storeName);
		            const request = store.add({ spotUid, data: base64Data, date: Date.now() });
		            request.onsuccess = () => resolve();
		            request.onerror = () => reject();
		        });
		    },
		
		    // Hent alle billeder til et specifikt fund
		    async getAll(spotUid) {
		        const db = await this.init();
		        return new Promise((resolve) => {
		            const tx = db.transaction(this.storeName, "readonly");
		            const store = tx.objectStore(this.storeName);
		            const index = store.index("spotUid");
		            const request = index.getAll(spotUid);
		            request.onsuccess = () => resolve(request.result);
		        });
		    },
		
		    // Slet et specifikt billede
		    async delete(photoId) {
		        const db = await this.init();
		        const tx = db.transaction(this.storeName, "readwrite");
		        tx.objectStore(this.storeName).delete(photoId);
		    }
		};

		// Hj√¶lpefunktion til at generere Naturbasen-linket
		function renderNaturbasenLink(url) {
			if (!url) return ''; // Hvis der ikke er et link, returneres intet

			return `
				<div class="mt-8 pt-6 border-t border-stone-100">
					<a href="${url}" target="_blank" rel="noopener noreferrer" 
					   class="flex items-center gap-4 w-full p-4 bg-white rounded-2xl border-2 border-stone-100 shadow-sm active:scale-[0.98] transition-all group">
						
						<div class="flex-shrink-0 w-12 h-12 bg-blue-900 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-inner uppercase tracking-tighter">
							NB.dk
						</div>

						<div class="flex flex-col text-left">
							<span class="text-[9px] font-black text-blue-900 uppercase tracking-widest leading-none mb-1">${ui.naturbasen_external_db}</span>
							<span class="text-[15px] font-bold text-stone-900 leading-tight group-hover:underline">${ui.naturbasen_see_confirm}</span>
						</div>

						<svg xmlns="http://www.w3.org/2000/svg" class="ml-auto h-5 w-5 text-stone-300 group-hover:text-blue-900 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
						</svg>
					</a>
					<p class="mt-2 text-[10px] text-stone-600 text-center px-6 italic">
						${ui.naturbasen_explainer}
					</p>
				</div>
			`;
		}

		function showPreservationGuide() {
			const modalHtml = `
				<div id="preservation-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
					<div class="fixed inset-0 bg-stone-900/90 backdrop-blur-md" onclick="closePreservationGuide()"></div>
					
					<div class="bg-white rounded-[40px] w-full max-w-xl max-h-[85vh] overflow-hidden relative z-10 shadow-2xl border border-stone-200 flex flex-col">
						
						<div class="p-8 pb-4 bg-white flex justify-between items-start">
							<div>
								<h3 class="text-3xl font-black uppercase italic tracking-tighter text-stone-900 leading-none">${ui.detail_preservation}</h3>
							</div>
							<button onclick="closePreservationGuide()" class="h-12 w-12 rounded-full bg-stone-100 flex items-center justify-center font-bold text-stone-500 hover:bg-stone-200 transition-all active:scale-90">‚úï</button>
						</div>

						<div class="flex-1 overflow-y-auto p-8 pt-4 space-y-12">
							
							<section>
								<div class="flex items-center gap-3 mb-4">
									<div class="w-12 h-12 rounded-2xl bg-amber-50 flex items-center justify-center text-2xl border border-amber-100">‚òÄÔ∏è</div>
									<div>
										<h4 class="font-black uppercase text-sm tracking-widest text-stone-800 italic leading-none">${ui.detail_preservation_drying}</h4>
										<span class="text-[10px] text-amber-600 font-bold uppercase tracking-tighter">${ui.detail_preservation_drying_best_for}</span>
									</div>
								</div>
								<div class="text-sm text-stone-600 space-y-3 leading-relaxed border-l-2 border-stone-100 pl-6 ml-6">
									<p>${ui.detail_preservation_drying_preparation}</p>
									<p>${ui.detail_preservation_drying_oven}</p>
									<p>${ui.detail_preservation_drying_time}</p>
									<div class="bg-amber-50/50 p-3 rounded-xl border border-amber-100 text-[12px] italic">
										${ui.detail_preservation_drying_tip}
									</div>
								</div>
							</section>

							<section>
								<div class="flex items-center gap-3 mb-4">
									<div class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center text-2xl border border-blue-100">‚ùÑÔ∏è</div>
									<div>
										<h4 class="font-black uppercase text-sm tracking-widest text-stone-800 italic leading-none">${ui.detail_preservation_frying}</h4>
										<span class="text-[10px] text-blue-600 font-bold uppercase tracking-tighter">${ui.detail_preservation_frying_best_for}</span>
									</div>
								</div>
								<div class="text-sm text-stone-600 space-y-3 leading-relaxed border-l-2 border-stone-100 pl-6 ml-6">
									<p>${ui.detail_preservation_frying_method}</p>
									<p>${ui.detail_preservation_frying_process}</p>
									<p>${ui.detail_preservation_frying_freeze}</p>
									<p>${ui.detail_preservation_frying_shelf_life}</p>
								</div>
							</section>

							<section>
								<div class="flex items-center gap-3 mb-4">
									<div class="w-12 h-12 rounded-2xl bg-rose-50 flex items-center justify-center text-2xl border border-rose-100">üß™</div>
									<div>
										<h4 class="font-black uppercase text-sm tracking-widest text-stone-800 italic leading-none">${ui.detail_preservation_pickling}</h4>
										<span class="text-[10px] text-rose-600 font-bold uppercase tracking-tighter">${ui.detail_preservation_pickling_best_for}</span>
									</div>
								</div>
								<div class="text-sm text-stone-600 space-y-3 leading-relaxed border-l-2 border-stone-100 pl-6 ml-6">
									<p>${ui.detail_preservation_pickling_brine}</p>
									<p>${ui.detail_preservation_pickling_process}</p>
									<p>${ui.detail_preservation_pickling_tip}</p>
								</div>
							</section>
						</div>

						<div class="p-8 bg-stone-50 border-t border-stone-100">
							<button onclick="closePreservationGuide()" class="w-full p-5 bg-stone-900 text-white rounded-[24px] font-black text-xs uppercase tracking-[0.2em] shadow-xl active:scale-95 transition-all">${ui.close}</button>
						</div>
					</div>
				</div>
			`;
			document.body.insertAdjacentHTML('beforeend', modalHtml);
		}

		function closePreservationGuide() {
			const modal = document.getElementById('preservation-modal');
			if (modal) {
				modal.classList.add('opacity-0');
				setTimeout(() => modal.remove(), 300);
			}
		}

        function renderResult(id) {
            const res = database[id];
			const allSpots = JSON.parse(localStorage.getItem('mySpots')) || [];
		    const mySpotsOfThisPlant = allSpots.filter(s => s.resId === id);
		    const hasExistingSpots = mySpotsOfThisPlant.length > 0;
			
		    // Lav HTML til "Se mine fund" linket
		    const mySpotsLink = mySpotsOfThisPlant.length > 0 ? `
			    <div class="mt-3">
			        <a href="#" onclick="event.preventDefault(); renderMySpots('${id}')" 
			           class="text-[11px] font-bold text-green-800 uppercase tracking-widest hover:underline flex items-center justify-center gap-1">
			        ${ui.detail_see_finds} (${mySpotsOfThisPlant.length})
			        </a>
			    </div>
			` : '';
			const hasTwin = res.twin && res.twin.name && !res.twin.no_twin;
			const notThisIf = res.not_this_if ? `
				<div class="bg-white p-2 rounded-2xl my-4 border border-red-100">
					<p class="text-red-800 text-[10px] font-black uppercase tracking-widest mb-2 px-2 italic">${ui.detail_not_this_if}</p>
					<ul class="list-none p-0 m-0">
						${res.not_this_if.map((text) => `
							<li class="flex items-baseline gap-3 py-1 border-b border-stone-100 last:border-0">
								<div class="h-1.5 w-1.5 rounded-full bg-red-500 shrink-0 transform translate-y-[-2px]"></div>
								<p class="text-stone-800 text-sm leading-tight text-left">
									${text}
								</p>
							</li>
						`).join('')}
					</ul>
				</div>	
			` : '';

			const currentMonth = new Date().getMonth();
			const isOutOfSeason = !res.months || !res.months.includes(ui.monthOrder[currentMonth]);
			const seasonHtml = isOutOfSeason ? `
				<div class="bg-amber-50 border-2 border-amber-200 p-4 rounded-xl my-2">
					<p class="text-amber-700 text-xs italic">${ui.detail_out_of_season}</p>
				</div>
			` : '';

            document.getElementById('app-content').innerHTML = `
				<div class="fab-container">
				    <button onclick="handleSaveLocation('${id}', this)" 
				            class="floating-save-btn active:scale-95">
				        <span>üìç</span>
				        <span>${ui.detail_save_spot}</span>
				    </button>
				</div>

				<div class="fade-in space-y-8 pb-10">
                    <div class="text-center">
                        <span class="type-badge badge-${res.type} mb-3 inline-block">${res.type}</span>
                        <h2 class="text-4xl font-black text-stone-900 uppercase italic tracking-tighter sans leading-none">${res.name}</h2>
                        <p class="text-stone-600 font-bold italic text-base mt-2">${res.latin}</p>
                    </div>
					${res.months && res.months.length > 0 ? `
                    <div class="card p-6 border-stone-100">
                        <div class="id-label mb-2 flex justify-between items-center">
                            <span>${ui.detail_season}</span>
                            <span class="text-stone-600">${
								res.months && res.months.length > 0 
									? `${res.months[0].toUpperCase()} - ${res.months[res.months.length - 1].toUpperCase()}`
									: `${ui.unknown}`
								}
							</span>
                        </div>
                        ${getSeasonalityHtml(res.months || [])}
						${seasonHtml}
                    </div>
					` : ''}
					
                    <div class="card p-8 border-l-[12px] border-green-800 shadow-md">
                        <div class="id-label">${ui.detail_traits}</div>
						<p class="text-lg font-medium text-stone-900 italic leading-relaxed mb-6">${res.extended_traits || res.traits || ""}</p>
						${notThisIf}
						${res.extended_habitat ? `
                        <div class="id-label">${ui.detail_growing_location}</div>
                        <p class="text-lg font-medium text-stone-900 italic leading-relaxed mb-6">${res.extended_habitat}</p>
						` : ''}
						<details class="group border border-stone-200 rounded-3xl bg-stone-50 overflow-hidden transition-all shadow-sm">
							<summary class="list-none cursor-pointer p-5 flex justify-between items-center bg-white group-open:bg-stone-100 transition-colors">
								<div class="flex items-center gap-3">
									<span class="text-[11px] font-black uppercase tracking-widest text-green-900 sans">${ui.detail_usage_and_preservation}</span>
								</div>
								<span class="text-stone-400 group-open:rotate-180 transition-transform text-[10px]">‚ñº</span>
							</summary>
							
							<div class="p-6 space-y-6 bg-stone-50/50 border-t border-stone-100">
								<div>
									<div class="text-[9px] font-black uppercase tracking-widest text-green-800 mb-2 sans opacity-60">${ui.detail_usage}</div>
									<p class="text-base font-medium text-stone-900 italic leading-relaxed">${res.usage}</p>
								</div>

								${res.cleaning ? `
								<div class="pt-5 border-t border-stone-200/60">
									<div class="text-[9px] font-black uppercase tracking-widest text-green-800 mb-2 sans opacity-60">${ui.detail_cleaning}</div>
									<p class="text-sm text-stone-800 italic leading-relaxed">${res.cleaning}</p>
								</div>
								` : ''}

								${res.preservation ? `
								<div class="pt-5 border-t border-stone-200/60">
									<div class="text-[9px] font-black uppercase tracking-widest text-green-800 mb-2 sans opacity-60">
								        ${ui.detail_usage_and_preservation}
								    </div>
								    <p class="text-sm text-stone-800 italic leading-relaxed mb-4">${res.preservation}</p>
								    
								    <button onclick="showPreservationGuide()" 
								            class="w-full flex items-center justify-between bg-white border border-green-200 p-3 rounded-2xl shadow-sm active:scale-[0.98] transition-all">
								        <div class="flex items-center gap-3">
								            <span class="text-lg">üçØ</span>
								            <div class="text-left">
								                <div class="text-[10px] font-black uppercase text-green-800 leading-none">${ui.detail_learn_techniques}</div>
								                <div class="text-xs text-stone-500 italic">${ui.detail_learn_techniques_guide}</div>
								            </div>
								        </div>
								        <span class="text-green-800 text-xs">‚Üí</span>
								    </button>
								</div>
								` : ''}
							</div>
						</details>
                    </div>

                    <div class="card p-8 bg-stone-50 border-stone-100">
                        <div class="id-label mb-4">${ui.detail_expert_keys}</div>
						<div class="space-y-5">
						    ${res.id_keys.map(item => `
						        <div>
						            <div class="text-[9px] font-black uppercase tracking-widest text-green-800 mb-1 sans">${item.label}</div>
						            <p class="text-base text-stone-800 font-medium italic leading-snug">${item.text}</p>
						        </div>
						    `).join('')}
						</div>
					</div>
					
					${res.twin ? `
                    <div class="p-8 rounded-[32px] ${res.twin.toxic ? 'bg-red-50 border-red-200' : 'bg-orange-50 border-orange-200'} border-2 shadow-sm">
                        <div class="flex items-center gap-4 mb-3">
							${res.twin.toxic ? `
                            <div class="w-15 h-10 px-2 rounded-full flex items-center justify-center bg-red-700 text-white font-bold">${ui.detail_toxic}</div>
							` : ''}
                            <div>
                                <div class="text-[9px] font-black uppercase sans">${ui.detail_lookalike}</div>
                                <div class="text-xl font-black text-stone-900 uppercase italic tracking-tighter sans">${res.twin.name}</div>
                            </div>
                        </div>
                        <p class="text-base font-medium text-stone-800 italic leading-relaxed">${res.twin.diff}</p>
                    </div>
					` : ''}

                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="window.open('https://www.google.com/search?tbm=isch&q=${encodeURIComponent(res.name + ' ' + res.latin)}', '_blank')" class="w-full p-6 bg-stone-900 text-white rounded-[24px] font-black text-[11px] uppercase tracking-widest text-center btn-active sans shadow-lg">${ui.detail_google_photos}</button>
                        ${hasTwin ? `
                            <button onclick="window.open('https://www.google.com/search?tbm=isch&q=${encodeURIComponent(res.twin.name + ' ${ui.detail_lookalike_identification}')}', '_blank')" class="w-full p-6 border-2 border-red-700 text-red-700 rounded-[24px] font-black text-[11px] uppercase tracking-widest text-center btn-active sans shadow-lg">${ui.detail_google_lookalike_photos}</button>
                        ` : ''}
                    </div>

					${renderNaturbasenLink(res.naturbasen)}
                </div>
            `;
        }

        function renderSafety() {
            document.getElementById('app-content').innerHTML = `
                <div class="fade-in space-y-6">
                    <h2 class="text-3xl font-black text-red-700 italic uppercase tracking-tighter sans leading-none">${ui.safety}</h2>
                    <div class="card p-8 space-y-6 border-red-100">
                        <p class="italic text-stone-600 font-medium">${ui.safety_1}</p>
                        <p class="italic text-stone-600 font-medium">${ui.safety_2}</p>
                        <p class="italic text-stone-600 font-medium">${ui.safety_3}</p>
                        <div class="p-5 bg-red-700 text-white rounded-2xl text-center font-black sans uppercase text-sm shadow-lg">${geoData[userSettings.country].poison_phone}</div>
                    </div>
                </div>
            `;
        }

		window.handleWizardChoice = function(index) {
		    // 1. Tjek at valget er gyldigt
		    if (currentWizardNode && currentWizardNode.choices && currentWizardNode.choices[index]) {
		        
		        // 2. Find det n√¶ste trin i tr√¶et
		        const nextNode = currentWizardNode.choices[index];
		        
		        // 3. Opdater den globale variabel
		        currentWizardNode = nextNode;
		        
		        // 4. VIGTIGT: Brug navigate() i stedet for renderWizard()
		        // Dette gemmer trinnet i historikken, s√• "Tilbage" virker
		        navigate('wizard', nextNode);
		    }
		};
		
        function renderWizard(node) {
			// SIKRER AT GLOBALE VARIABLE ER SYNKRONISERET
		    if (typeof node === 'object') {
		        currentWizardNode = node;
		    }
			let content = '';

			//Template for Option List
            const wrap = (title, desc, options) => `
                <div class="fade-in space-y-6 text-center">
                    <h2 class="text-2xl font-black italic sans text-stone-900">${title}</h2>
                    <p class="text-stone-600 italic px-4 font-medium">${desc}</p>
                    <div class="grid grid-cols-1 gap-3">${options}</div>
                    <button onclick="navigate('start')" class="mt-4 text-[10px] uppercase font-bold text-stone-600 tracking-widest">${ui.abort}</button>
                </div>`;

			//Template for Option
            const btn = (index, text, text_more) => `
                <button onclick="handleWizardChoice(${index})" class="p-6 card bg-white border border-stone-100 shadow-sm flex flex-col items-start btn-active group">
                    <span class="font-bold sans text-stone-800 text-sm text-left">${text}</span>
                     ${text_more ? `<span class="sans text-stone-600 italic text-sm text-left">${text_more}</span>` : ''}					 
                </button>`;

			// Template for Warnings (Dead ends)
			const renderWarning = (text) => `
				<div class="fade-in p-8 bg-red-50 border-4 border-red-700 rounded-[32px] text-center space-y-6 shadow-xl">
					<div class="text-6xl">‚ö†Ô∏è</div>
					<h3 class="text-3xl font-black text-red-700 uppercase sans tracking-tighter">${ui.warning}</h3>
					<p class="font-bold text-red-900 text-lg leading-relaxed">${text}</p>
					<button onclick="navigate('start')" class="w-full p-5 bg-red-700 hover:bg-red-800 text-white rounded-2xl font-bold mt-4 sans uppercase tracking-widest transition-colors shadow-lg">${ui.close}</button>
				</div>`;

			// Template for Notices (Dead ends)
			const renderNotice = (text) => `
				<div class="fade-in p-8 bg-amber-50 border-4 border-amber-700 rounded-[32px] text-center space-y-6 shadow-xl">
					<div class="text-6xl">‚úã</div>
					<h3 class="text-3xl font-black text-amber-700 uppercase sans tracking-tighter">${ui.notice}</h3>
					<p class="font-bold text-amber-900 text-lg leading-relaxed">${text}</p>
					<button onclick="navigate('start')" class="w-full p-5 bg-amber-700 hover:bg-amber-800 text-white rounded-2xl font-bold mt-4 sans uppercase tracking-widest transition-colors shadow-lg">${ui.understood}</button>
				</div>`;
		
			if (!node || node === 'START') {
				content = wrap(`${ui.wizard}`, `${ui.wizard_observe}`, `
					<button onclick="navigate('wizard', 'STOP_POISON')" class="p-5 card bg-red-700 text-white font-black sans uppercase btn-active">${ui.wizard_observe_yes}</button>
					<button onclick="navigate('wizard', 'PROCEED')" class="p-5 card bg-green-700 text-white font-black sans uppercase btn-active">${ui.wizard_observe_no}</button>
				`); 

				document.getElementById('app-content').innerHTML = content;
				window.scrollTo(0,0);
				return;
			}
			else if (node === 'STOP_POISON') {
				content = `<div class="fade-in p-8 bg-red-50 border-4 border-red-700 rounded-[32px] text-center space-y-4"><h3 class="text-3xl font-black text-red-700 uppercase sans">${ui.wizard_stop}</h3><p class="font-bold text-red-900 italic">${ui.wizard_stop_description}</p><button onclick="navigate('start')" class="w-full p-4 bg-red-700 text-white rounded-2xl font-bold mt-4 sans uppercase">${ui.abort}</button></div>`; 

				document.getElementById('app-content').innerHTML = content;
				window.scrollTo(0,0);
				return;
			}
			else if (node === 'PROCEED') {
				currentWizardNode = wizardMushroomData;
				node = currentWizardNode;
			}
			
			if (node.warning) {
				// CASE: Warning / Dead End
				content = renderWarning(node.warning);
			}
			else if (node.notice) {
				// CASE: Notification / Dead End
				content = renderNotice(node.notice);
			} 
			else if (node.id) {
				// CASE: Identification Successful
				navigate(node.id);
				return;
			} 
			else if (node.choices) {
				// Generate HTML for all buttons based on the 'match' property
				const optionsHtml = node.choices.map((choice, index) => {
					return btn(index, choice.match, choice.text_more);
				}).join('');

				// Use node.prompt for title, and node.description for instructions
				content = wrap(
					node.prompt || `${ui.wizard_please_choose}:`, 
					node.description || "", 
					optionsHtml
				);
			} 
			else {
				// Fallback
				content = `<div class="text-center py-10"><p>${ui.wizard_error}</p><button onclick="navigate('start')">${ui.wizard_restart}</button></div>`;
			}
            document.getElementById('app-content').innerHTML = content;
            window.scrollTo(0,0);
        }
		
        function navigate(pageId, data = null) {
			closeMenuIfOpen();
			
		    // Gemmer tilstanden i browserens historik
		    window.history.pushState({ pageId: pageId, data: data }, "", "");
		    render(pageId, data);
		}
		function goBack() {
		    window.history.back();
		}

		async function getGuessedLocation() {
		    try {
		        const response = await fetch('https://ipapi.co/json/');
		        const data = await response.json();
		        
		        return {
		            lang: data.languages.split(',')[0].split('-')[0], 
		            country: data.country_code
		        };
		    } catch (e) {
		        return null; // Fallback hvis tjenesten er nede
		    }
		}

		async function initApp() {
			try {
				// 1. Hent konfigurationen
				const [configRes, geoRes] = await Promise.all([
				        fetch('config.json'),
				        fetch('geo_data.json')
				    ]);
				appConfig = await configRes.json();
			    geoData = await geoRes.json();
				
				// 2. Tjek om vi har gemte indstillinger, ellers start "G√¶t-processen"
				const saved = localStorage.getItem('userSettings');
				if (saved) {
					userSettings = JSON.parse(saved);
				} else {
					// G√¶t sprog fra browser
					const urlLang = new URLSearchParams(window.location.search).get('lang');
					const geo = await getGuessedLocation();
					let finalLang = urlLang || (geo ? geo.lang : null) || navigator.language.split('-')[0];
					
					// Hvis browser-sproget ikke findes i vores config, brug 'da' som fallback
					if (!appConfig.languages[finalLang]) {
						finalLang = 'da';
					}
		
					// Find standard-landet for det g√¶ttede sprog
					const langData = appConfig.languages[finalLang];
					const countryCode = langData.defaultCountry;
		
					userSettings = {
						lang: finalLang,
						country: countryCode,
						region: geoData[countryCode].regions[0] // Tag f√∏rste region som default
					};
					
					saveSettings(); // Gem de g√¶ttede indstillinger
				}
				
				renderLanguageOptions();
				await handleLangChange(userSettings.lang, false); // false = genindl√¶s ikke hele siden endnu		
			} catch (err) {
				console.error("Fejl under opstart:", err);
			}

			// Erstat den nuv√¶rende "tomme" state med startsiden
		    window.history.replaceState({ pageId: 'start' }, "", "");
		    render('start');
		}
		
		window.onpopstate = function(event) {
		    if (event.state) {
		        render(event.state.pageId, event.state.data);
		    } else {
		        // Fallback hvis historikken er tom
		        render('start');
		    }
		};

		document.addEventListener('DOMContentLoaded', () => {
			// Registrer Service Worker til offline brug
		    if ('serviceWorker' in navigator) {
		        window.addEventListener('load', () => {
		            navigator.serviceWorker.register('./sw.js')
		                .then((registration) => {
		                    console.log('ServiceWorker registrering succesfuld med scope: ', registration.scope);
		                })
		                .catch((error) => {
		                    console.log('ServiceWorker registrering fejlede: ', error);
		                });
		        });
		    }
			initApp();
		});
    </script>
</body>
</html>



















